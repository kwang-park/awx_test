---
- name: test
  hosts: all
  tasks:
    - name: "delete netplan infiniband yaml"
      file:
        path: "/etc/netplan/infiniband.yaml"
        state: absent

    - name: "touch netplan infiniband yaml"
      file:
        path: "/etc/netplan/infiniband.yaml"
        state: touch

    - name: ib start ip setup
      set_fact:
        ib_ip: "{{ IB_IP_START.split('.') }}"

    - name: cur backend num setup
      set_fact:
        backend_num: "{{ ansible_play_batch.index(inventory_hostname) + 1 }}"

    - name: print backend num
      debug:
        msg: "{{backend_num}}"

    - name: ib ip setup-1
      blockinfile:
        path: /etc/netplan/infiniband.yaml
        insertafter: EOF
        block: |
          network:
            ethernets:

    - name: ib ip setup-2
      blockinfile:
        path: /etc/netplan/infiniband.yaml
        insertafter: EOF
        marker: "# {mark} ib{{item.0}} INSERTION"
        block: |
          # ib {{item.0}}
              ib{{item.0}}:
                addresses:
                - "{{ ib_ip[0] }}.{{ ib_ip[1] }}.{{ ib_ip[2]|int + (C_ALPHA|int * (backend_num|int - 1) / D_ALPHA|int)|int }}.{{ (((backend_num|int - 1) % D_ALPHA|int) + 1 + (item.0 * D_ALPHA|int)) }}"
                dhcp4: false
      with_indexed_items:
        - "{{ ib_ip }}"
